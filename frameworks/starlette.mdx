---
title: "Starlette"
description: "The little ASGI framework that shines."
---

## Add middleware

To get started, create a new app in Apitally and select Starlette as your framework.

Install the [Apitally Python client](https://pypi.org/project/apitally/) in your Starlette project (e.g. using `pip` or `poetry`) with the `starlette` extra.

<CodeGroup>
```shell pip
pip install apitally[starlette]
```

```toml poetry (pyproject.toml)
[tool.poetry.dependencies]
apitally = { version = "*", extras = ["starlette"] }
```

</CodeGroup>

Add the Apitally middleware to your Starlette application and provide the `client_id` for your app.
The `client_id` is displayed in Apitally immediately after creating the app or on the _Setup instructions_ page for your app.

You can use the optional `env` argument to provide a name for the current environment, otherwise _default_ will be used.
New environments will be visible in Apitally as soon as data is received from them. You can mark environments as production or non-production on the _Manage environments_ screen.

```python
from starlette.applications import Starlette
from apitally.starlette import ApitallyMiddleware

app = Starlette(routes=[...])
app.add_middleware(
    ApitallyMiddleware,
    client_id="your-client-id",
    env="your-env-name",
)
```

<div className="-mt-4">
  <Note>
    If you're also using other middlewares, put the `ApitallyMiddleware` last,
    so that it wraps the existing stack of middlewares.
  </Note>
</div>

## Configure API key auth

Enable the synchronization of API key hashes from Apitally to your application by setting the `enable_keys` argument to `True` when adding the middleware.

```python
app.add_middleware(
    ApitallyMiddleware,
    client_id="your-client-id",
    env="your-env-name",
    enable_keys=True,  # <--
)
```

<div className="-mt-4">
  <Snippet file="api-key-sync-info.mdx" />
</div>

Add Starlette's [`AuthenticationMiddleware`](https://www.starlette.io/authentication/) with the `APIKeyBackend` to your app,
and then use the [`@requires`](https://www.starlette.io/authentication/#permissions) decorator to secure your endpoints with API authentication.
Always include the `authenticated` scope and optionally any other required scopes.

You can access information about the API key in your endpoint function via the [`request.user`](https://www.starlette.io/authentication/#users) and
[`request.auth`](https://www.starlette.io/authentication/#authcredentials) objects. This can be useful if you need to check scopes dynamically, for example.

<CodeGroup>

```python Authentication
from starlette.authentication import requires
from starlette.middleware.authentication import AuthenticationMiddleware
from starlette.routing import Route
from apitally.starlette import ApitallyMiddleware, APIKeyBackend

@requires(["authenticated", "read:items"])
def list_items():
    return ["item1"]

routes = [
    Route("/items", list_items, methods=["GET"]),
]

app = Starlette(routes=routes)
app.add_middleware(ApitallyMiddleware, client_id="your-client-id", enable_keys=True)
app.add_middleware(AuthenticationMiddleware, backend=APIKeyBackend())
```

```python Access key info
from starlette.authentication import requires
from starlette.middleware.authentication import AuthenticationMiddleware
from starlette.requests import Request
from starlette.routing import Route
from apitally.starlette import ApitallyMiddleware, APIKeyBackend

@requires(["authenticated"])
def list_items(request: Request):
    assert request.user.is_authenticated
    assert request.auth.check_scopes(["read:items"])
    print("Key name:", request.user.display_name)
    print("Key scopes:", request.auth.scopes)
    return ["item1"]

routes = [
    Route("/items", list_items, methods=["GET"]),
]

app = Starlette(routes=routes)
app.add_middleware(ApitallyMiddleware, client_id="your-client-id", enable_keys=True)
app.add_middleware(AuthenticationMiddleware, backend=APIKeyBackend())
```

</CodeGroup>

<Snippet file="use-api-keys.mdx" />
